<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="./style/main.css">
	<title>Test</title>
	<script src="./js/writer.js"></script>
</head>

<body>
	<div class="column">
		<div class="editor">
			<textarea id="editing" spellcheck="false" oninput="update(this.value); sync_scroll(this);"
				onscroll="sync_scroll(this);" onkeydown="check_tab(this, event);"></textarea>
			<pre><code id="highlighting-content" class="highlight"></code></pre>
		</div>
	</div>
	<div class="column">
		<div class="tree-view"></div>
		<div class="temp-console"></div>
	</div>
</body>
<script src="./js/tree.js"></script>
<script type="module">
	import {
		InputStream
	} from "./lib/input-stream.js";
	import {
		TokenStream
	} from "./lib/token-stream.js";
	import {
		parse
	} from "./lib/parser.js";
	import {
		evaluate,
		Environment
	} from "./lib/interpreter.js";
	import {
		make_js
	} from "./lib/transpiler.js";
	const textarea = document.querySelector("textarea");
	const tempConsole = document.querySelector(".temp-console");

	const write = (txt) => console.log(txt);
	const globalEnv = new Environment()
	globalEnv.def("print", write);

	textarea.addEventListener("input", (e) => {
		let value = e.currentTarget.value;
		const stream = new InputStream(value);
		const tokens = new TokenStream(stream)
		const tokenized = []
		while (tokens.peek()) {
			tokenized.push(tokens.next())
		}

		stream.reset()

		const parsed = parse(tokens);
		Array.from(tempConsole.getElementsByTagName("*")).forEach(element => {
			element.remove()
		});
		Array.from(document.querySelector(".tree-view").getElementsByTagName("*")).forEach(element => {
			element.remove()
		});
		makeTree(parsed)
		var t0 = performance.now();
		//evaluate(parsed, globalEnv)
		var time = performance.now() - t0
		//write(`Execution Took: ${time}ms`)
		const jsCode = make_js(parsed);
		t0 = performance.now()
		new Function(jsCode)();
		time = performance.now() - t0
		write(`Transpiled code took: ${time}ms`)
	})


	var value = `
# Heading 1
## Heading 2

This is some normal text

{%
	// This is embedded code (a comment to be precise)
	print("Hello World!");

	x = 5;
%}

---

- This is a *list*
- With multiple **items**

<div>
	{{x}}
</div>

This is no > blockquote

> This is a blockquote

![This is some image](https://www.google.com/images/branding/googlelogo/2x/googlelogo_color_272x92dp.png)

[This is a link](https://continuum-ai.de)
	`;
	import {
		Tokenizer
	} from "./lib/md/tokenizer.js";
	import {
		Parser
	} from "./lib/md/parser.js";

	import {parseAndEvaluate} from "./lib/md/parse-evaluate.js";

	let code = [];
	value = value.replace(/\{%(.*?)%\}/gms, (all, first) => {
		code.push(first)
		return ""
	})

	parseAndEvaluate(code.join(""), globalEnv)
	let variables = globalEnv.vars;

	value = value.replace(/\{\{(.*?)\}\}/gm, (all, first) => {
		return variables[first.trim()]
	})

	let stream = new Tokenizer(new InputStream(value))

	new Parser(stream.tokens)


	textarea.value = `
// Function declaration with (func keyword)
fib = func (n) {
	if n < 2 then n else fib(n - 1) + fib(n - 2);
};
// Variable Declaration
x = 5 ** 2;
print(fib(22));
print([1,2,3, [1,2,3]]);
// Allow PHP-Like accessing of properties.
// someObject->someProperty = "Something";
// print(someObject->someProperty);

// And pointers of course!!!
// x = 5
// y = &x
// y = 6 # => x = 6`
	textarea.dispatchEvent(new Event("input"))
</script>

</html>

<head></head>